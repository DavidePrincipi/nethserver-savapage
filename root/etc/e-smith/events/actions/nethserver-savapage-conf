#!/bin/bash

# do all here and not at build

# create db and user if not exists

su - postgres -c "psql -c \"CREATE USER savapage WITH PASSWORD '$(cat /var/lib/nethserver/secrets/savapage)';\""
su - postgres -c "createdb -O savapage -E UTF8 savapage -T template0"
su - postgres -c "psql -c \"grant all privileges on database savapage to savapage;\""

# install savapage

mkdir /opt/savapage
chown -R savapage:savapage /opt/savapage
cd /opt/savapage

# get savapage

su savapage -c "wget -nc https://www.savapage.org/download/snapshots/savapage-setup-0.9.12-linux-x64.bin"
su savapage -c "chmod u+x savapage-setup-0.9.12-linux-x64.bin"

# run non-interactive setup as savapage user

su savapage -c "./savapage-setup-0.9.12-linux-x64.bin -n"

# run as root for installing services

/opt/savapage/MUST-RUN-AS-ROOT
systemctl stop savapage

# initialize db, only done when not initialized already

su savapage -c "/opt/savapage/server/bin/linux-x64/savapage-db --db-init"
systemctl enable savapage
systemctl start savapage
